<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¨ºæ‰€æˆæ¬Šç®¡ç† - å¤šè¨ºæ‰€ç®¡ç†ä¸­å¿ƒ</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", sans-serif;
      background: #f5f7fa;
      color: #333;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 30px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo-icon {
      font-size: 32px;
    }

    .header-title h1 {
      font-size: 24px;
      margin-bottom: 4px;
    }

    .header-title p {
      font-size: 13px;
      opacity: 0.9;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-block;
    }

    .btn-back {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid white;
      color: white;
    }

    .btn-back:hover {
      background: white;
      color: #667eea;
    }

    /* Container */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    /* Clinics Table */
    .clinics-table {
      background: white;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      overflow: hidden;
    }

    .table-header {
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .table-header h2 {
      font-size: 20px;
      margin-bottom: 5px;
    }

    .table-header p {
      font-size: 13px;
      opacity: 0.9;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: #f8f9fa;
    }

    th {
      padding: 15px;
      text-align: left;
      font-weight: 600;
      color: #666;
      font-size: 13px;
      text-transform: uppercase;
    }

    td {
      padding: 15px;
      border-top: 1px solid #eee;
    }

    tr:hover {
      background: #f8f9fa;
    }

    .status-badge {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-authorized {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .status-unauthorized {
      background: #ffebee;
      color: #c62828;
    }

    .subscription-badge {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }

    .subscription-active {
      background: #e3f2fd;
      color: #1565c0;
    }

    .subscription-inactive {
      background: #fce4ec;
      color: #ad1457;
    }

    .subscription-expired {
      background: #fff3e0;
      color: #e65100;
    }

    .action-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.3s;
      margin-right: 5px;
    }

    .btn-authorize {
      background: #4caf50;
      color: white;
    }

    .btn-authorize:hover {
      background: #45a049;
    }

    .btn-revoke {
      background: #f44336;
      color: white;
    }

    .btn-revoke:hover {
      background: #da190b;
    }

    .btn-extend {
      background: #2196f3;
      color: white;
    }

    .btn-extend:hover {
      background: #0b7dda;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: white;
      border-radius: 15px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 20px;
      color: #333;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #666;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 25px;
    }

    .modal-actions button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
    }

    .btn-confirm {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }

    .btn-confirm:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-cancel {
      background: #e0e0e0;
      color: #666;
    }

    .btn-cancel:hover {
      background: #d0d0d0;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <div class="logo-icon">ğŸ”</div>
      <div class="header-title">
        <h1>è¨ºæ‰€æˆæ¬Šç®¡ç†</h1>
        <p>Clinic Authorization Management</p>
      </div>
    </div>
    <a href="multi-clinic-dashboard.html" class="btn btn-back">â† è¿”å›å„€è¡¨æ¿</a>
  </div>

  <!-- Main Container -->
  <div class="container">
    <div class="clinics-table">
      <div class="table-header">
        <h2>ğŸ“‹ è¨ºæ‰€æˆæ¬Šåˆ—è¡¨</h2>
        <p>ç®¡ç†è¨ºæ‰€çš„æˆæ¬Šç‹€æ…‹å’Œè¨‚é–±æœŸé™</p>
      </div>

      <div id="tableContent">
        <div class="loading">
          <div class="spinner"></div>
          <p>è¼‰å…¥ä¸­...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Authorization Modal -->
  <div id="authModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">ğŸ”“ æˆæ¬Šè¨ºæ‰€</div>
      <div class="form-group">
        <label>è¨ºæ‰€åç¨±</label>
        <input type="text" id="modalClinicName" readonly>
      </div>
      <div class="form-group">
        <label>è¨‚é–±æœŸé™ï¼ˆæœˆï¼‰</label>
        <select id="modalDuration">
          <option value="1">1 å€‹æœˆ</option>
          <option value="3">3 å€‹æœˆ</option>
          <option value="6">6 å€‹æœˆ</option>
          <option value="12" selected>12 å€‹æœˆï¼ˆ1å¹´ï¼‰</option>
          <option value="24">24 å€‹æœˆï¼ˆ2å¹´ï¼‰</option>
        </select>
      </div>
      <div class="modal-actions">
        <button class="btn-confirm" onclick="confirmAuthorization()">ç¢ºèªæˆæ¬Š</button>
        <button class="btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <script>
    // Supabase é…ç½®
    const SUPABASE_URL = 'https://pizzpwesrbulfjylejlu.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBpenpwd2VzcmJ1bGZqeWxlamx1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzE4MzU2NjYsImV4cCI6MjA0NzQxMTY2Nn0.5pYm8aCPSKdYFDqPSZzCxNqPaD2Ij3Yd_XQXK8qYqSM';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentClinicId = null;

    // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
    function checkAuth() {
      const isAuthenticated = sessionStorage.getItem('adminAuth');
      if (!isAuthenticated) {
        window.location.href = 'multi-clinic-login.html';
      }
    }

    // è¼‰å…¥è¨ºæ‰€åˆ—è¡¨
    async function loadClinics() {
      try {
        const { data: clinics, error } = await supabase
          .from('clinics')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;

        const tableHtml = `
          <table>
            <thead>
              <tr>
                <th>è¨ºæ‰€åç¨±</th>
                <th>æˆæ¬Šç‹€æ…‹</th>
                <th>è¨‚é–±ç‹€æ…‹</th>
                <th>è¨‚é–±æœŸé™</th>
                <th>æˆæ¬Šäºº</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              ${clinics.map(clinic => {
                const isAuthorized = clinic.is_authorized;
                const subscriptionStatus = clinic.subscription_status || 'inactive';
                const endDate = clinic.subscription_end_date ? new Date(clinic.subscription_end_date) : null;
                const isExpired = endDate && endDate < new Date();
                
                let statusClass = 'subscription-inactive';
                let statusText = 'æœªå•Ÿç”¨';
                if (subscriptionStatus === 'active' && !isExpired) {
                  statusClass = 'subscription-active';
                  statusText = 'å•Ÿç”¨ä¸­';
                } else if (isExpired) {
                  statusClass = 'subscription-expired';
                  statusText = 'å·²éæœŸ';
                }

                return `
                  <tr>
                    <td><strong>${clinic.name}</strong><br><small style="color: #999;">${clinic.slug}</small></td>
                    <td>
                      <span class="status-badge ${isAuthorized ? 'status-authorized' : 'status-unauthorized'}">
                        ${isAuthorized ? 'âœ… å·²æˆæ¬Š' : 'âŒ æœªæˆæ¬Š'}
                      </span>
                    </td>
                    <td>
                      <span class="subscription-badge ${statusClass}">
                        ${statusText}
                      </span>
                    </td>
                    <td>
                      ${endDate ? endDate.toLocaleDateString('zh-TW') : '-'}
                      ${endDate && !isExpired ? `<br><small style="color: #999;">å‰©é¤˜ ${Math.ceil((endDate - new Date()) / (1000 * 60 * 60 * 24))} å¤©</small>` : ''}
                    </td>
                    <td>${clinic.authorized_by || '-'}</td>
                    <td>
                      ${!isAuthorized ? 
                        `<button class="action-btn btn-authorize" onclick="openAuthModal(${clinic.id}, '${clinic.name}')">æˆæ¬Š</button>` :
                        `<button class="action-btn btn-revoke" onclick="revokeAuthorization(${clinic.id})">æ’¤éŠ·</button>
                         <button class="action-btn btn-extend" onclick="extendSubscription(${clinic.id})">å»¶é•·</button>`
                      }
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        `;

        document.getElementById('tableContent').innerHTML = tableHtml;

      } catch (error) {
        console.error('è¼‰å…¥è¨ºæ‰€åˆ—è¡¨å¤±æ•—:', error);
        document.getElementById('tableContent').innerHTML = `
          <div class="loading">
            <p style="color: #c62828;">âŒ è¼‰å…¥å¤±æ•—: ${error.message}</p>
          </div>
        `;
      }
    }

    // é–‹å•Ÿæˆæ¬Š Modal
    function openAuthModal(clinicId, clinicName) {
      currentClinicId = clinicId;
      document.getElementById('modalClinicName').value = clinicName;
      document.getElementById('authModal').style.display = 'flex';
    }

    // é—œé–‰ Modal
    function closeModal() {
      document.getElementById('authModal').style.display = 'none';
      currentClinicId = null;
    }

    // ç¢ºèªæˆæ¬Š
    async function confirmAuthorization() {
      if (!currentClinicId) return;

      const duration = parseInt(document.getElementById('modalDuration').value);
      const startDate = new Date();
      const endDate = new Date();
      endDate.setMonth(endDate.getMonth() + duration);

      try {
        const { error } = await supabase
          .from('clinics')
          .update({
            is_authorized: true,
            subscription_status: 'active',
            subscription_start_date: startDate.toISOString(),
            subscription_end_date: endDate.toISOString(),
            authorized_by: 'ç®¡ç†å“¡',
            authorized_at: new Date().toISOString()
          })
          .eq('id', currentClinicId);

        if (error) throw error;

        alert('âœ… æˆæ¬ŠæˆåŠŸï¼');
        closeModal();
        loadClinics();

      } catch (error) {
        console.error('æˆæ¬Šå¤±æ•—:', error);
        alert('âŒ æˆæ¬Šå¤±æ•—: ' + error.message);
      }
    }

    // æ’¤éŠ·æˆæ¬Š
    async function revokeAuthorization(clinicId) {
      if (!confirm('ç¢ºå®šè¦æ’¤éŠ·æ­¤è¨ºæ‰€çš„æˆæ¬Šå—ï¼Ÿ')) return;

      try {
        const { error } = await supabase
          .from('clinics')
          .update({
            is_authorized: false,
            subscription_status: 'inactive',
            subscription_end_date: new Date().toISOString()
          })
          .eq('id', clinicId);

        if (error) throw error;

        alert('âœ… å·²æ’¤éŠ·æˆæ¬Š');
        loadClinics();

      } catch (error) {
        console.error('æ’¤éŠ·æˆæ¬Šå¤±æ•—:', error);
        alert('âŒ æ’¤éŠ·å¤±æ•—: ' + error.message);
      }
    }

    // å»¶é•·è¨‚é–±
    async function extendSubscription(clinicId) {
      const months = prompt('è«‹è¼¸å…¥è¦å»¶é•·çš„æœˆæ•¸ï¼š', '12');
      if (!months || isNaN(months)) return;

      try {
        // å…ˆå–å¾—ç›®å‰çš„è¨‚é–±æœŸé™
        const { data: clinic, error: fetchError } = await supabase
          .from('clinics')
          .select('subscription_end_date')
          .eq('id', clinicId)
          .single();

        if (fetchError) throw fetchError;

        let newEndDate = new Date(clinic.subscription_end_date || new Date());
        if (newEndDate < new Date()) {
          newEndDate = new Date();
        }
        newEndDate.setMonth(newEndDate.getMonth() + parseInt(months));

        const { error } = await supabase
          .from('clinics')
          .update({
            subscription_end_date: newEndDate.toISOString(),
            subscription_status: 'active'
          })
          .eq('id', clinicId);

        if (error) throw error;

        alert(`âœ… å·²å»¶é•·è¨‚é–± ${months} å€‹æœˆ`);
        loadClinics();

      } catch (error) {
        console.error('å»¶é•·è¨‚é–±å¤±æ•—:', error);
        alert('âŒ å»¶é•·å¤±æ•—: ' + error.message);
      }
    }

    // åˆå§‹åŒ–
    checkAuth();
    loadClinics();
  </script>
</body>
</html>
