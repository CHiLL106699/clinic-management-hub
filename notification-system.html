<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æˆæ¬Šé€šçŸ¥ç³»çµ± - å¤šè¨ºæ‰€ç®¡ç†ä¸­å¿ƒ</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", sans-serif;
      background: #f5f7fa;
      color: #333;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 30px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo-icon {
      font-size: 32px;
    }

    .header-title h1 {
      font-size: 24px;
      margin-bottom: 4px;
    }

    .header-title p {
      font-size: 13px;
      opacity: 0.9;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-block;
      color: white;
    }

    .btn-back {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid white;
    }

    .btn-back:hover {
      background: white;
      color: #667eea;
    }

    /* Container */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    /* Card */
    .card {
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }

    .card-header h2 {
      font-size: 20px;
      color: #333;
    }

    .card-icon {
      font-size: 28px;
    }

    /* Settings */
    .setting-group {
      margin-bottom: 25px;
    }

    .setting-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .setting-label h3 {
      font-size: 16px;
      color: #333;
    }

    .toggle-switch {
      position: relative;
      width: 50px;
      height: 26px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: #4caf50;
    }

    input:checked + .slider:before {
      transform: translateX(24px);
    }

    .setting-description {
      font-size: 14px;
      color: #666;
      margin-top: 5px;
    }

    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .checkbox-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .checkbox-item label {
      font-size: 14px;
      color: #333;
      cursor: pointer;
    }

    /* Notification Log */
    .notification-log {
      max-height: 400px;
      overflow-y: auto;
    }

    .log-item {
      padding: 15px;
      border-left: 4px solid #667eea;
      background: #f8f9fa;
      margin-bottom: 10px;
      border-radius: 5px;
    }

    .log-item.success {
      border-left-color: #4caf50;
    }

    .log-item.error {
      border-left-color: #f44336;
    }

    .log-time {
      font-size: 12px;
      color: #999;
      margin-bottom: 5px;
    }

    .log-message {
      font-size: 14px;
      color: #333;
    }

    .log-clinic {
      font-size: 13px;
      color: #666;
      margin-top: 5px;
    }

    /* Button */
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 30px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-danger {
      background: #f44336;
      color: white;
      padding: 12px 30px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-danger:hover {
      background: #d32f2f;
      transform: translateY(-2px);
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <span class="logo-icon">ğŸ””</span>
      <div class="header-title">
        <h1>æˆæ¬Šé€šçŸ¥ç³»çµ±</h1>
        <p>Notification System</p>
      </div>
    </div>
    <a href="multi-clinic-dashboard.html" class="btn btn-back">â† è¿”å›å„€è¡¨æ¿</a>
  </div>

  <!-- Main Container -->
  <div class="container">
    <!-- é€šçŸ¥è¨­å®š -->
    <div class="card">
      <div class="card-header">
        <span class="card-icon">âš™ï¸</span>
        <h2>é€šçŸ¥è¨­å®š</h2>
      </div>

      <div class="setting-group">
        <div class="setting-label">
          <h3>å•Ÿç”¨è‡ªå‹•é€šçŸ¥</h3>
          <label class="toggle-switch">
            <input type="checkbox" id="autoNotification" checked>
            <span class="slider"></span>
          </label>
        </div>
        <p class="setting-description">è‡ªå‹•æª¢æŸ¥ä¸¦ç™¼é€è¨‚é–±åˆ°æœŸæé†’é€šçŸ¥</p>
      </div>

      <div class="setting-group">
        <div class="setting-label">
          <h3>é€šçŸ¥æ™‚é–“é»</h3>
        </div>
        <div class="checkbox-group">
          <div class="checkbox-item">
            <input type="checkbox" id="notify7days" checked>
            <label for="notify7days">åˆ°æœŸå‰ 7 å¤©</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="notify3days" checked>
            <label for="notify3days">åˆ°æœŸå‰ 3 å¤©</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="notify1day" checked>
            <label for="notify1day">åˆ°æœŸå‰ 1 å¤©</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="notifyExpired" checked>
            <label for="notifyExpired">å·²éæœŸ</label>
          </div>
        </div>
      </div>

      <div class="setting-group">
        <div class="setting-label">
          <h3>æˆæ¬Šè®Šæ›´é€šçŸ¥</h3>
          <label class="toggle-switch">
            <input type="checkbox" id="authChangeNotification" checked>
            <span class="slider"></span>
          </label>
        </div>
        <p class="setting-description">ç•¶è¨ºæ‰€æˆæ¬Šç‹€æ…‹è®Šæ›´æ™‚ï¼Œè‡ªå‹•ç™¼é€ LINE é€šçŸ¥çµ¦è¨ºæ‰€ç®¡ç†å“¡</p>
      </div>

      <div class="button-group">
        <button class="btn-primary" onclick="saveSettings()">ğŸ’¾ å„²å­˜è¨­å®š</button>
        <button class="btn-primary" onclick="checkNow()">ğŸ” ç«‹å³æª¢æŸ¥</button>
        <button class="btn-danger" onclick="clearLogs()">ğŸ—‘ï¸ æ¸…é™¤è¨˜éŒ„</button>
      </div>
    </div>

    <!-- é€šçŸ¥è¨˜éŒ„ -->
    <div class="card">
      <div class="card-header">
        <span class="card-icon">ğŸ“‹</span>
        <h2>é€šçŸ¥è¨˜éŒ„</h2>
      </div>
      <div id="notificationLog" class="notification-log">
        <div class="loading">è¼‰å…¥ä¸­...</div>
      </div>
    </div>
  </div>

  <script>
    // Supabase è¨­å®š
    const SUPABASE_URL = 'https://pizzpwesrbulfjylejlu.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBpenpwd2VzcmJ1bGZqeWxlamx1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzE4NTU0NTIsImV4cCI6MjA0NzQzMTQ1Mn0.kBvSHCNBUlLkqjBnVDXm7Ry8vqaYpqULQUbfNyxFGbk';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
    function checkAuth() {
      const isAuthenticated = sessionStorage.getItem('adminAuth');
      if (!isAuthenticated) {
        window.location.href = 'multi-clinic-login.html';
      }
    }

    // è¼‰å…¥é€šçŸ¥è¨˜éŒ„
    async function loadNotificationLogs() {
      try {
        // é€™è£¡å¯ä»¥å¾è³‡æ–™åº«è¼‰å…¥é€šçŸ¥è¨˜éŒ„
        // ç›®å‰å…ˆé¡¯ç¤ºç¯„ä¾‹
        const logs = [
          {
            time: '2025-11-17 20:30:00',
            type: 'success',
            message: 'æˆåŠŸç™¼é€åˆ°æœŸæé†’é€šçŸ¥',
            clinic: 'é‚Šç¾è¨ºæ‰€ - è¨‚é–±å°‡æ–¼ 7 å¤©å¾Œåˆ°æœŸ'
          }
        ];

        const logHtml = logs.map(log => `
          <div class="log-item ${log.type}">
            <div class="log-time">${log.time}</div>
            <div class="log-message">${log.message}</div>
            <div class="log-clinic">${log.clinic}</div>
          </div>
        `).join('');

        document.getElementById('notificationLog').innerHTML = logHtml || '<div class="loading">æš«ç„¡é€šçŸ¥è¨˜éŒ„</div>';
      } catch (error) {
        console.error('Error loading logs:', error);
        document.getElementById('notificationLog').innerHTML = '<div class="loading">è¼‰å…¥å¤±æ•—</div>';
      }
    }

    // å„²å­˜è¨­å®š
    async function saveSettings() {
      const settings = {
        autoNotification: document.getElementById('autoNotification').checked,
        notify7days: document.getElementById('notify7days').checked,
        notify3days: document.getElementById('notify3days').checked,
        notify1day: document.getElementById('notify1day').checked,
        notifyExpired: document.getElementById('notifyExpired').checked,
        authChangeNotification: document.getElementById('authChangeNotification').checked
      };

      // å„²å­˜åˆ° localStorage
      localStorage.setItem('notificationSettings', JSON.stringify(settings));
      alert('âœ… è¨­å®šå·²å„²å­˜ï¼');
    }

    // ç«‹å³æª¢æŸ¥
    async function checkNow() {
      try {
        const { data: clinics, error } = await supabase
          .from('clinics')
          .select('*')
          .eq('is_authorized', true);

        if (error) throw error;

        let notifications = [];
        const now = new Date();

        clinics.forEach(clinic => {
          if (clinic.subscription_end_date) {
            const endDate = new Date(clinic.subscription_end_date);
            const daysLeft = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));

            if (daysLeft === 7 || daysLeft === 3 || daysLeft === 1) {
              notifications.push({
                clinic: clinic.name,
                daysLeft: daysLeft,
                message: `è¨‚é–±å°‡æ–¼ ${daysLeft} å¤©å¾Œåˆ°æœŸ`
              });
            } else if (daysLeft <= 0) {
              notifications.push({
                clinic: clinic.name,
                daysLeft: daysLeft,
                message: 'è¨‚é–±å·²éæœŸ'
              });
            }
          }
        });

        if (notifications.length > 0) {
          const message = notifications.map(n => `${n.clinic}: ${n.message}`).join('\n');
          alert(`ğŸ”” ç™¼ç¾ ${notifications.length} å€‹éœ€è¦é€šçŸ¥çš„è¨ºæ‰€ï¼š\n\n${message}`);
        } else {
          alert('âœ… ç›®å‰æ²’æœ‰éœ€è¦ç™¼é€é€šçŸ¥çš„è¨ºæ‰€');
        }
      } catch (error) {
        console.error('Error checking:', error);
        alert('âŒ æª¢æŸ¥å¤±æ•—ï¼š' + error.message);
      }
    }

    // æ¸…é™¤è¨˜éŒ„
    function clearLogs() {
      if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰é€šçŸ¥è¨˜éŒ„å—ï¼Ÿ')) {
        document.getElementById('notificationLog').innerHTML = '<div class="loading">æš«ç„¡é€šçŸ¥è¨˜éŒ„</div>';
        alert('âœ… è¨˜éŒ„å·²æ¸…é™¤');
      }
    }

    // è¼‰å…¥è¨­å®š
    function loadSettings() {
      const settings = localStorage.getItem('notificationSettings');
      if (settings) {
        const parsed = JSON.parse(settings);
        document.getElementById('autoNotification').checked = parsed.autoNotification !== false;
        document.getElementById('notify7days').checked = parsed.notify7days !== false;
        document.getElementById('notify3days').checked = parsed.notify3days !== false;
        document.getElementById('notify1day').checked = parsed.notify1day !== false;
        document.getElementById('notifyExpired').checked = parsed.notifyExpired !== false;
        document.getElementById('authChangeNotification').checked = parsed.authChangeNotification !== false;
      }
    }

    // åˆå§‹åŒ–
    checkAuth();
    loadSettings();
    loadNotificationLogs();
  </script>
</body>
</html>
