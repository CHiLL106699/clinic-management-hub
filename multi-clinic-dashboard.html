<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¤šè¨ºæ‰€ç®¡ç†ä¸­å¿ƒ - å„€è¡¨æ¿</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", sans-serif;
      background: #f5f7fa;
      min-height: 100vh;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 30px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-title {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .header-title h1 {
      font-size: 24px;
      font-weight: 600;
    }

    .header-actions {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-block;
    }

    .btn-white {
      background: white;
      color: #667eea;
    }

    .btn-white:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 255, 255, 0.3);
    }

    .btn-outline {
      background: transparent;
      color: white;
      border: 2px solid white;
    }

    .btn-outline:hover {
      background: white;
      color: #667eea;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    }

    .stat-icon {
      font-size: 32px;
      margin-bottom: 10px;
    }

    .stat-label {
      color: #666;
      font-size: 14px;
      margin-bottom: 5px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #333;
    }

    .section-title {
      font-size: 20px;
      font-weight: 600;
      color: #333;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .clinics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .clinic-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.3s;
      border-left: 4px solid #667eea;
    }

    .clinic-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    }

    .clinic-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 15px;
    }

    .clinic-name {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
    }

    .clinic-status {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-active {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .status-expired {
      background: #ffebee;
      color: #c62828;
    }

    .clinic-info {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 15px;
      font-size: 14px;
      color: #666;
    }

    .clinic-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 13px;
      flex: 1;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .btn-secondary {
      background: #f5f5f5;
      color: #333;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .empty-state-text {
      color: #666;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <div class="header-title">
        <span style="font-size: 32px;">ğŸ¥</span>
        <h1>å¤šè¨ºæ‰€ç®¡ç†ä¸­å¿ƒ</h1>
      </div>
      <div class="header-actions">
        <a href="/payment-methods.html" class="btn btn-white">ğŸ’³ ä»˜æ¬¾æ–¹å¼</a>
        <button class="btn btn-outline" onclick="logout()">ç™»å‡º</button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- çµ±è¨ˆå¡ç‰‡ -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">ğŸ¥</div>
        <div class="stat-label">è¨‚é–±è¨ºæ‰€ç¸½æ•¸</div>
        <div class="stat-value" id="totalClinics">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">âœ…</div>
        <div class="stat-label">å•Ÿç”¨ä¸­è¨ºæ‰€</div>
        <div class="stat-value" id="activeClinics">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">ğŸ“…</div>
        <div class="stat-label">ç¸½é ç´„æ•¸</div>
        <div class="stat-value" id="totalBookings">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">â°</div>
        <div class="stat-label">å¾…è™•ç†é ç´„</div>
        <div class="stat-value" id="pendingBookings">0</div>
      </div>
    </div>

    <!-- è¨ºæ‰€åˆ—è¡¨ -->
    <h2 class="section-title">
      <span>ğŸ“‹</span>
      è¨ºæ‰€åˆ—è¡¨
    </h2>

    <div id="loadingState" class="loading">
      <div class="spinner"></div>
      <p>è¼‰å…¥ä¸­...</p>
    </div>

    <div id="clinicsContainer" class="clinics-grid" style="display: none;">
      <!-- è¨ºæ‰€å¡ç‰‡å°‡å‹•æ…‹æ’å…¥é€™è£¡ -->
    </div>

    <div id="emptyState" class="empty-state" style="display: none;">
      <div class="empty-state-icon">ğŸ¥</div>
      <div class="empty-state-text">ç›®å‰å°šç„¡è¨ºæ‰€è³‡æ–™</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Supabase é…ç½®
    const SUPABASE_URL = 'https://pizzpwesrbulfjylejlu.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBpenpwd2VzcmJ1bGZqeWxlamx1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2NDE1MzgsImV4cCI6MjA3NjIxNzUzOH0.xkVhoQhKBaPGkBzU1tuzAH49rP91gUaBLZFffcnKZIk';
    
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
    function checkAuth() {
      if (sessionStorage.getItem('multiClinicAuth') !== 'true') {
        window.location.href = '/multi-clinic-login.html';
        return false;
      }
      
      const loginTime = parseInt(sessionStorage.getItem('loginTime'));
      const now = Date.now();
      
      // Session æœ‰æ•ˆæœŸ 24 å°æ™‚
      if (now - loginTime >= 24 * 60 * 60 * 1000) {
        sessionStorage.removeItem('multiClinicAuth');
        sessionStorage.removeItem('loginTime');
        window.location.href = '/multi-clinic-login.html';
        return false;
      }
      
      return true;
    }

    // ç™»å‡º
    function logout() {
      sessionStorage.removeItem('multiClinicAuth');
      sessionStorage.removeItem('loginTime');
      window.location.href = '/multi-clinic-login.html';
    }

    // è¼‰å…¥çµ±è¨ˆè³‡æ–™
    async function loadStats() {
      try {
        // è¼‰å…¥è¨ºæ‰€çµ±è¨ˆ
        const { data: clinics, error: clinicsError } = await supabase
          .from('clinics')
          .select('*');
        
        if (clinicsError) throw clinicsError;

        const totalClinics = clinics?.length || 0;
        const activeClinics = clinics?.filter(c => c.subscriptionStatus === 'active').length || 0;

        document.getElementById('totalClinics').textContent = totalClinics;
        document.getElementById('activeClinics').textContent = activeClinics;

        // è¼‰å…¥é ç´„çµ±è¨ˆ
        const { data: bookings, error: bookingsError } = await supabase
          .from('yuemeiBookings')
          .select('*');
        
        if (bookingsError) throw bookingsError;

        const totalBookings = bookings?.length || 0;
        const pendingBookings = bookings?.filter(b => b.status === 'pending').length || 0;

        document.getElementById('totalBookings').textContent = totalBookings;
        document.getElementById('pendingBookings').textContent = pendingBookings;

      } catch (error) {
        console.error('è¼‰å…¥çµ±è¨ˆè³‡æ–™å¤±æ•—:', error);
      }
    }

    // è¼‰å…¥è¨ºæ‰€åˆ—è¡¨
    async function loadClinics() {
      try {
        const { data: clinics, error } = await supabase
          .from('clinics')
          .select('*')
          .order('createdAt', { ascending: false });
        
        if (error) throw error;

        const loadingState = document.getElementById('loadingState');
        const clinicsContainer = document.getElementById('clinicsContainer');
        const emptyState = document.getElementById('emptyState');

        loadingState.style.display = 'none';

        if (!clinics || clinics.length === 0) {
          emptyState.style.display = 'block';
          return;
        }

        clinicsContainer.style.display = 'grid';
        clinicsContainer.innerHTML = clinics.map(clinic => createClinicCard(clinic)).join('');

      } catch (error) {
        console.error('è¼‰å…¥è¨ºæ‰€åˆ—è¡¨å¤±æ•—:', error);
        document.getElementById('loadingState').innerHTML = `
          <p style="color: #c62828;">è¼‰å…¥å¤±æ•—: ${error.message}</p>
        `;
      }
    }

    // å»ºç«‹è¨ºæ‰€å¡ç‰‡
    function createClinicCard(clinic) {
      const isActive = clinic.subscriptionStatus === 'active';
      const statusClass = isActive ? 'status-active' : 'status-expired';
      const statusText = isActive ? 'âœ“ å•Ÿç”¨ä¸­' : 'âœ— å·²éæœŸ';
      
      const expiryDate = clinic.subscriptionExpiry 
        ? new Date(clinic.subscriptionExpiry).toLocaleDateString('zh-TW')
        : 'æœªè¨­å®š';

      return `
        <div class="clinic-card">
          <div class="clinic-header">
            <div>
              <div class="clinic-name">${clinic.clinicName || 'æœªå‘½åè¨ºæ‰€'}</div>
              <div style="font-size: 12px; color: #999;">ID: ${clinic.id}</div>
            </div>
            <span class="clinic-status ${statusClass}">${statusText}</span>
          </div>
          <div class="clinic-info">
            <div>ğŸ“± LINE Bot ID: ${clinic.lineBotId || 'æœªè¨­å®š'}</div>
            <div>ğŸ“… è¨‚é–±åˆ°æœŸ: ${expiryDate}</div>
            <div>ğŸ• å»ºç«‹æ™‚é–“: ${new Date(clinic.createdAt).toLocaleDateString('zh-TW')}</div>
          </div>
          <div class="clinic-actions">
            <button class="btn btn-primary btn-small" onclick="openClinicDashboard('${clinic.adminUrl}')">
              é€²å…¥å¾Œå°
            </button>
            <button class="btn btn-secondary btn-small" onclick="viewClinicDetails(${clinic.id})">
              æŸ¥çœ‹è©³æƒ…
            </button>
          </div>
        </div>
      `;
    }

    // é–‹å•Ÿè¨ºæ‰€å¾Œå°
    function openClinicDashboard(adminUrl) {
      if (adminUrl && adminUrl !== 'null') {
        window.open(adminUrl, '_blank');
      } else {
        alert('æ­¤è¨ºæ‰€å°šæœªè¨­å®šå¾Œå°ç¶²å€');
      }
    }

    // æŸ¥çœ‹è¨ºæ‰€è©³æƒ…
    function viewClinicDetails(clinicId) {
      alert(`æŸ¥çœ‹è¨ºæ‰€ ID: ${clinicId} çš„è©³ç´°è³‡è¨Š\n\næ­¤åŠŸèƒ½é–‹ç™¼ä¸­...`);
    }

    // åˆå§‹åŒ–
    if (checkAuth()) {
      loadStats();
      loadClinics();
    }
  </script>
</body>
</html>
